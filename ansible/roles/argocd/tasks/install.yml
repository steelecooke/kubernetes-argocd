---
- name: ARGOCD INSTALL | Deploy namespace
  k8s:
    api_version: v1
    kind: Namespace
    name: "{{ argocd_k8s_namespace }}"
    state: "{{ argocd_action }}"
  run_once: yes

- run_once: yes
  block:
    - name: ARGOCD KUBERNETES | Download Kubernetes yaml file definition
      get_url:
        url: https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
        dest: /tmp/argocd_install.yaml
        owner: root
        group: root
        mode: 0440

    - name: ARGOCD KUBERNETES | Manage Kubernetes objects
      k8s:
        namespace: "{{ argocd_k8s_namespace }}"
        src: /tmp/argocd_install.yaml
        state: "{{ argocd_action }}"
  always:
    - name: ARGOCD KUBERNETES | Clean installation
      file:
        path: /tmp/argocd_install.yaml
        state: absent

- name: ARGOCD INSTALL | Download command line tool
  get_url:
    url: "{{ argocd_cli_url }}"
    dest: "{{ argocd_cli_path }}"
    owner: root
    group: root
    mode: 0755

- name: ARGOCD INSTALL | Manage admin user
  import_tasks: user.yml

- name: ARGOCD INSTALL | Manage repositories
  import_tasks: repositories.yml

- name: ARGOCD INSTALL | Deploy Argo CD Applications
  hosts: argocd_server
  tasks:
    - name: Apply Argo CD application manifests
      shell: kubectl apply -f {{ item }}
      loop: "{{ lookup('fileglob', 'roles/argocd/manifests/**/*.yml', wantlist=true) }}"
